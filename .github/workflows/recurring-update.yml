name: recurring-update

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout only update.sh
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            update.sh
          sparse-checkout-cone-mode: false
          fetch-depth: 1

      - name: Install GitHub CLI
        run: sudo apt-get install -y gh

      - name: Run update script
        run: bash ./update.sh

      - name: Upload files to GitHub via API
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          BRANCH="main"
          COMMIT_MSG="Automated constellation data update via API"

          find . -type f \( -name "*.tle" \) | while read -r FILE; do
            FILE_PATH="${FILE#./}"  # Remove ./ prefix
            ENCODED_CONTENT=$(base64 -w 0 "$FILE")

            # Try to get current file SHA (if exists)
            SHA=$(gh api -H "Accept: application/vnd.github+json" \
              repos/$REPO/contents/$FILE_PATH \
              --jq .sha 2>/dev/null || true)

            echo "Uploading: $FILE_PATH"

            # Upload using GitHub API
          gh api --method PUT \
            -H "Accept: application/vnd.github+json" \
            repos/$REPO/contents/$FILE_PATH \
            -f message="$COMMIT_MSG" \
            -f content="$ENCODED_CONTENT" \
            -f branch="$BRANCH" \
            ${SHA:+-f "sha=$SHA"}
          done


