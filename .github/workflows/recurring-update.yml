name: recurring-update

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout minimal (for access to script)
        uses: actions/checkout@v4
        with:
          sparse-checkout: update.sh
          sparse-checkout-cone-mode: false
          fetch-depth: 1

      - name: Run update.sh to generate files
        run: ./update.sh

      - name: Upload files using GitHub API
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Set metadata
          REPO="${{ github.repository }}"
          BRANCH="main"
          COMMIT_MSG="Automated file update via API"
          
          for file in $(find ./output_dir -type f); do
            FILE_PATH="${file#./}"  # Remove ./ prefix
            ENCODED_CONTENT=$(base64 -w 0 "$file")
            FILE_NAME=$(basename "$file")

            # Try to get the file's SHA if it exists
            SHA=$(gh api \
              -H "Accept: application/vnd.github+json" \
              repos/$REPO/contents/$FILE_PATH \
              --jq '.sha' || true)

            # Call the create/update endpoint
            gh api --method PUT \
              -H "Accept: application/vnd.github+json" \
              repos/$REPO/contents/$FILE_PATH \
              -f message="$COMMIT_MSG" \
              -f content="$ENCODED_CONTENT" \
              -f branch="$BRANCH" \
              ${SHA:+-f sha=$SHA}
          done


